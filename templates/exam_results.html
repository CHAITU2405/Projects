{% extends "base.html" %}

{% block title %}Exam Results - {{ exam_session.domain.replace('_', ' ').title() }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Results Header -->
        <div class="card">
            <div class="card-body text-center">
                <h2 class="card-title">
                    <i class="fas fa-trophy me-2"></i>Exam Results
                </h2>
                <p class="text-muted">{{ exam_session.domain.replace('_', ' ').title() }} Domain</p>
                
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">{{ exam_session.score }}</h3>
                            <small class="text-muted">Correct Answers</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info">{{ exam_session.total_questions }}</h3>
                            <small class="text-muted">Total Questions</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            {% set tq = exam_session.total_questions or 0 %}
                            {% set pct = (exam_session.score / tq) * 100 if tq > 0 else 0 %}
                            <h3 class="text-success">{{ "%.1f"|format(pct) }}%</h3>
                            <small class="text-muted">Score</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-warning">{{ exam_session.end_time.strftime('%H:%M') }}</h3>
                            <small class="text-muted">Completed At</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="{{ url_for('student_dashboard') }}" class="btn btn-primary me-2">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                    <button class="btn btn-outline-secondary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print Results
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Performance Summary -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>Performance Summary
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="progress mb-3" style="height: 25px;">
                            {% set tq2 = exam_session.total_questions or 0 %}
                            {% set pct2 = ((exam_session.score / tq2) * 100) if tq2 > 0 else 0 %}
                            <div class="progress-bar bg-success" 
                                 style="width: {{ pct2 }}%">
                                {{ exam_session.score }}/{{ tq2 }}
                            </div>
                        </div>
                        <small class="text-muted">Overall Score</small>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between">
                            <span>Correct: <strong class="text-success">{{ exam_session.score }}</strong></span>
                            <span>Incorrect: <strong class="text-danger">{{ exam_session.total_questions - exam_session.score }}</strong></span>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Rating -->
                <div class="mt-3">
                    {% set percentage = ((exam_session.score / exam_session.total_questions) * 100) if exam_session.total_questions > 0 else 0 %}
                    {% if percentage >= 90 %}
                        <div class="alert alert-success">
                            <i class="fas fa-star me-2"></i>
                            <strong>Excellent!</strong> Outstanding performance. Keep up the great work!
                        </div>
                    {% elif percentage >= 80 %}
                        <div class="alert alert-info">
                            <i class="fas fa-thumbs-up me-2"></i>
                            <strong>Very Good!</strong> Great job! You have a solid understanding of the material.
                        </div>
                    {% elif percentage >= 70 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-hand-paper me-2"></i>
                            <strong>Good!</strong> Well done! Consider reviewing areas where you made mistakes.
                        </div>
                    {% elif percentage >= 60 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Fair.</strong> You passed, but there's room for improvement. Focus on weak areas.
                        </div>
                    {% else %}
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Needs Improvement.</strong> Consider reviewing the material and retaking the exam.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Detailed Results -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-list me-2"></i>Question-by-Question Results
                </h5>
                
                {% for response in responses %}
                {% set question = questions|selectattr("id", "equalto", response.question_id)|first %}
                <div class="card mb-3 {% if response.is_correct %}border-success{% else %}border-danger{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">
                                Question {{ loop.index }}
                            </h6>
                            <span class="badge {% if response.is_correct %}bg-success{% else %}bg-danger{% endif %}">
                                {% if response.is_correct %}
                                    <i class="fas fa-check me-1"></i>Correct
                                {% else %}
                                    <i class="fas fa-times me-1"></i>Incorrect
                                {% endif %}
                            </span>
                        </div>
                        
                        <p class="card-text">{{ question.question_text }}</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">Your Answer:</h6>
                                <div class="p-2 rounded {% if response.is_correct %}bg-success text-white{% else %}bg-danger text-white{% endif %}">
                                    {% if question.question_type == 'short_text' %}
                                        <strong>{{ response.user_answer }}</strong>
                                    {% else %}
                                        <strong>{{ response.user_answer }}.</strong>
                                        {% if response.user_answer == 'A' %}{{ question.option_a }}
                                        {% elif response.user_answer == 'B' %}{{ question.option_b }}
                                        {% elif response.user_answer == 'C' %}{{ question.option_c }}
                                        {% elif response.user_answer == 'D' %}{{ question.option_d }}
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if not response.is_correct %}
                            <div class="col-md-6">
                                <h6 class="text-muted">Correct Answer:</h6>
                                <div class="p-2 rounded bg-success text-white">
                                    {% if question.question_type == 'short_text' %}
                                        <strong>{{ (question.correct_answer_text or '') }}</strong>
                                    {% else %}
                                        <strong>{{ question.correct_answer }}.</strong>
                                        {% if question.correct_answer == 'A' %}{{ question.option_a }}
                                        {% elif question.correct_answer == 'B' %}{{ question.option_b }}
                                        {% elif question.correct_answer == 'C' %}{{ question.option_c }}
                                        {% elif question.correct_answer == 'D' %}{{ question.option_d }}
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Answered at: {{ response.answered_at.strftime('%H:%M:%S') }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-lightbulb me-2"></i>Recommendations
                </h5>
                
                {% set percentage = (exam_session.score / exam_session.total_questions) * 100 %}
                {% if percentage >= 90 %}
                    <div class="alert alert-success">
                        <h6><i class="fas fa-trophy me-2"></i>Outstanding Achievement!</h6>
                        <ul class="mb-0">
                            <li>Consider taking advanced courses in this domain</li>
                            <li>Share your knowledge with peers</li>
                            <li>Explore real-world applications of your skills</li>
                        </ul>
                    </div>
                {% elif percentage >= 80 %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-star me-2"></i>Strong Performance!</h6>
                        <ul class="mb-0">
                            <li>Review incorrect answers to identify weak areas</li>
                            <li>Practice with more challenging questions</li>
                            <li>Consider mentoring others in this domain</li>
                        </ul>
                    </div>
                {% elif percentage >= 70 %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-thumbs-up me-2"></i>Good Effort!</h6>
                        <ul class="mb-0">
                            <li>Focus on understanding concepts you missed</li>
                            <li>Practice with similar questions</li>
                            <li>Consider reviewing foundational materials</li>
                        </ul>
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h6>
                        <ul class="mb-0">
                            <li>Review all incorrect answers thoroughly</li>
                            <li>Study foundational concepts in this domain</li>
                            <li>Consider taking a preparatory course</li>
                            <li>Practice with basic questions before retaking</li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
